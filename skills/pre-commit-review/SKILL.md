---
name: pre-commit-review
description: Summarizes modified files in detail and reviews code to ensure changes do not affect other functionality. Use when the user asks for modification summary, code review, pre-commit review, or to ensure changes pass functional testing without introducing new issues. Trigger terms include: 审查代码、审查修改、review代码、代码审查、代码复审、测试代码、修改总结、提交前审查、不影响其他功能、审查结果不通过、回归测试、功能测试、修改review、审查变更. If the intent is ambiguous (e.g. 检查一下、看一下代码), ask the user to confirm: "是否需要按提交前审查流程，做修改总结 + 场景矩阵 + 代码审查？". If review fails, state the reason clearly.
---

# 提交前修改总结与代码审查

本技能用于在**提交前**对本次修改做详细总结与代码审查，确保功能测试通过、不引入新问题、不影响需求外的功能。

## 触发场景

用户表达以下**任一含义**时应用本技能（含但不限于）：

- **审查类**：审查代码、审查修改、review代码、代码审查、代码复审、修改审查、审查变更、修改review
- **总结类**：详细总结修改、修改总结、变更总结
- **提交前**：提交前审查、提交前检查、commit 前审查、提交前review
- **质量/测试类**：测试代码、回归测试、功能测试、确保不影响其他功能、不引入新问题、审查结果不通过则告知原因

**若有疑问**：若用户意图不明确（例如仅说「检查一下」「看一下代码」「帮我看下」），先询问确认：「是否需要按提交前审查流程，做修改总结 + 场景矩阵 + 代码审查？」确认后再执行。

## 执行步骤

### 1. 收集修改范围

- 使用 `git status -s`、`git diff --cached --stat`（或 `git diff --stat`）确定本次修改的文件与行数。
- 若用户未指定范围，以当前暂存区或工作区变更为准。

### 2. 详细总结修改

对**每个修改文件**写出：

- **文件路径**：相对项目根的路径。
- **修改类型**：新增 / 修改 / 删除。
- **修改要点**：用列表说明改了什么（逻辑、条件、顺序、依赖等），可引用关键代码或行号。
- **修改目的**：与需求或问题的对应关系（修复什么、优化什么、限制在什么场景）。

格式示例：

```markdown
### 文件路径
- **类型**：修改
- **要点**：① …；② …
- **目的**：…
```

### 3. 代码审查（不影响其他功能）

对每个修改点做**影响面分析**：

| 审查项 | 说明 |
|--------|------|
| **需求内行为** | 本次修改在「目标场景」下是否按预期工作（条件、分支、顺序、依赖是否正确）。 |
| **需求外行为** | 未改动的场景、平台、入口、用户类型是否仍按原逻辑执行（是否有误判、误跳过、误拦截）。 |
| **边界与平台** | 若修改与「平台/环境/登录方式」相关，是否用明确条件（如 isWechat、route.query.xxx）限制，避免其他平台被影响。 |
| **依赖与顺序** | 是否依赖未完成的数据（如 userInfo 未拉取）、执行顺序是否会导致竞态或误报。 |
| **未修改的关联代码** | 路由守卫、请求拦截、401 处理、全局配置等是否未改且与本次逻辑兼容。 |

对**关键分支与条件**做场景矩阵（可选但推荐）：

- 列出：场景（平台/登录态/URL/配置） → 预期行为 → 修改后是否一致。
- 重点覆盖：非目标平台、未登录、其他登录方式、异常/401、配置未加载等。

### 4. 审查结论

- **通过**：写明「符合预期，不影响其他功能」，并简述关键保障点（如：仅微信内生效、条件已加 isWechat 等）。
- **不通过**：**明确写出原因**，例如：
  - 「某条件下会误弹/误跳过，原因：…」
  - 「某平台/某登录方式会受影响，原因：…」
  - 「与某未修改逻辑冲突，原因：…」
  - 「缺少边界判断，建议：…」

不通过时必须给出**具体原因**和**修改建议**，不要只写「审查不通过」。

### 5. 输出审查文档

- **必须**将本次「修改总结 + 场景矩阵 + 审查结论」写入项目 **`docs/review/`** 下的审查文档。
- 文件名建议：`<需求或需求标识>-review.md` 或 `<日期或主题>-review.md`（如 `AI-748-review.md`、`wechat-login-prompt-fix-review.md`）。
- 文档内容至少包含：修改文件列表与要点、场景矩阵（场景 → 预期 → 结论）、审查结论（通过/不通过及原因）、不影响其他功能检查清单（可选但推荐）。
- 若项目根目录下无 `docs/review/`，先创建该目录再写入；若已有 `docs/review/README.md`，可仅在 README 中补充本次审查文档的索引或说明（可选）。

## 审查不通过时的处理

1. **明确告知用户**：审查不通过，并列出原因（逐条，可带文件与行号或条件）。
2. **给出修改建议**：如何改才能通过（例如补充 isWechat、调整顺序、增加条件）。
3. **不执行提交**：在用户根据建议修改并再次审查通过前，不进行 git commit；若用户坚持提交，提醒风险并记录原因。

## 更好的做法（推荐）

1. **先定范围再改**：修改前明确「只动哪些文件、只影响哪些场景」，审查时重点核对是否越界。
2. **平台/入口显式限制**：凡「仅某平台或某入口」才生效的逻辑，用显式条件（如 isWechat、route.query.xxx、配置开关）包裹，避免其他平台误走。
3. **场景矩阵**：对登录、平台、URL、配置等做一张「场景 → 预期 → 结论」表，避免漏掉边界。
4. **关联代码看一眼**：修改了 layout/请求/路由相关逻辑时，顺带确认 permission、request 拦截、401 处理未改且兼容。
5. **审查文档沉淀**：每次审查都将「修改总结 + 场景矩阵 + 审查结论」写入 `docs/review/`，便于后续回归和排查（本技能执行步骤 5 已规定必须写入）。

## 输出约定

- 总结与审查结论以**中文**呈现（除非项目约定英文）。
- 审查不通过时，**原因**单独成段或列表，便于用户一眼看到。
- 不通过时必须包含**修改建议**，便于用户整改后再次审查。

## 小结

- **目的**：确保每次修改在提交前功能测试通过，不引入新问题，不影响需求外的功能。
- **通过**：写明符合预期且不影响其他功能，并点出关键保障。
- **不通过**：明确原因 + 修改建议，不执行提交直至用户修复并再次审查通过（或用户明确坚持提交时提醒风险）。
